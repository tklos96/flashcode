<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FLASH5 Test: fortran/FLASH5/source/numericalTools/RungeKutta/RungeKuttaMain/RungeKutta_stepSizeEstimate.F90 File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FLASH5 Test
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_9d95adc37effe2d0447790667f945c24.html">fortran</a></li><li class="navelem"><a class="el" href="dir_aaca5e2157f58805ddf087a6c1d4d986.html">FLASH5</a></li><li class="navelem"><a class="el" href="dir_d9542af6519f0ca27bc6117ad523d5c6.html">source</a></li><li class="navelem"><a class="el" href="dir_1e5049951a47af6c299d4f194035013b.html">numericalTools</a></li><li class="navelem"><a class="el" href="dir_0b924fe236fa5e97438d96db733faef9.html">RungeKutta</a></li><li class="navelem"><a class="el" href="dir_a718d355e1f0a936a03fbd49ab457b06.html">RungeKuttaMain</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">RungeKutta_stepSizeEstimate.F90 File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a361c672613dc9d4e46fe839594409965"><td class="memItemLeft" align="right" valign="top">real function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_runge_kutta_main_2_runge_kutta__step_size_estimate_8_f90.html#a361c672613dc9d4e46fe839594409965">rungekutta_stepsizeestimate</a> (method, f, x, y, eFrac, eBase, hmax)</td></tr>
<tr class="separator:a361c672613dc9d4e46fe839594409965"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a361c672613dc9d4e46fe839594409965"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a361c672613dc9d4e46fe839594409965">&#9670;&nbsp;</a></span>rungekutta_stepsizeestimate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function rungekutta_stepsizeestimate </td>
          <td>(</td>
          <td class="paramtype">character (len=*), intent(in)&#160;</td>
          <td class="paramname"><em>method</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>f</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension     (:), intent(in)&#160;</td>
          <td class="paramname"><em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>eFrac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (:), intent(in)&#160;</td>
          <td class="paramname"><em>eBase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hmax</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p></p>
<p>RungeKutta_stepSizeEstimate (character (len=*), intent (in) :: method, function, intent (in) :: f, real, intent (in) :: x, real, intent (in) :: y (:), real, intent (in) :: eFrac, real, intent (in) :: eBase (:), real, intent (in) :: hmax)</p>
<p></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">method</td><td>the type of RK method for which the estimate is </td></tr>
    <tr><td class="paramname">f</td><td>the ODE function containing details of the ODE system to be solved </td></tr>
    <tr><td class="paramname">x</td><td>the initial value of the independent variable </td></tr>
    <tr><td class="paramname">y</td><td>the initial values of the dependent variable(s) </td></tr>
    <tr><td class="paramname">eFrac</td><td>the fractional value for each of the error base values </td></tr>
    <tr><td class="paramname">eBase</td><td>the error base values for each of the dependent variables </td></tr>
    <tr><td class="paramname">hmax</td><td>the safeguard maximum allowed step size</td></tr>
  </table>
  </dd>
</dl>
<p>NAME</p>
<p>RungeKutta_stepSizeEstimate</p>
<p>DESCRIPTION</p>
<p>This function provides the user with an initial estimate in step size, based on the error vector supplied and the ODE function 'f' to be solved. The estimate is based on all local information at 'x' and is obtained as follows. Consider the finite Taylor expansion of y (x+h) around 'x': </p><pre class="fragment">     y(x+h) = y(x) + hy'(x) + (h^2/2)y''(x) + ... + (h^p/p!)y^p(x) + O[h^(p+1)]
</pre><p>The truncation error O[h^(p+1)] can be expressed exactly as: </p><pre class="fragment">     O[h^(p+1)] = h^(p+1)/(p+1)! * y^(p+1)(x*)   x* between x and x+h
</pre><p>where the neglected higher order terms of the Taylor expansion have been accounted for by the definition of x*. Taking only the leading error term E(p+!) in O[h^(p+1)] is equivalent of setting x*=x in the above equation: </p><pre class="fragment">        E(p+1) = h^(p+1)/(p+1)! * y^(p+1)(x)
</pre><p>A Runge Kutta step of order p is like a Taylor expansion of order p and leads also to an error term O[h^(p+1)]. Hence to estimate the step size of a Runge Kutta of order p one could simply use the expression for E(p+1) and equate it with the error goal of the Runge Kutta step: </p><pre class="fragment">         Runge Kutta error goal &lt;= eFrac * eBase
</pre><p>and solve for h in the equation: </p><pre class="fragment">                eFrac * eBase &gt;= E(p+1)
                eFrac * eBase &gt;= h^(p+1)/(p+1)! * y^(p+1)(x)
</pre><p>Since eBase and y^(p+1)(x) are vectors, the equation is actually a set of equations, one for each of the corresponding vector elements. This results in a set of different h values, of which we will take the smallest: </p><pre class="fragment">                h &lt;= [eFrac * (p+1)! * min |eBase/y^(p+1)(x)|]^(1/(p+1))
</pre><p> or h &lt;= [eFrac * (p+1)! / max |y^(p+1)(x)/eBase|]^(1/(p+1))</p>
<p>One of the difficulties with the above equation is that for high orders it becomes difficult to estimate the higher order derivative vector y^(p+1)(x). To circumvent this problem and to use lower order derivatives, it is posulated that the eBase-rescaled higher order Taylor expansion errors decay in form of a power law: </p><pre class="fragment">            E(p+1)/eBase = [E(m)/eBase]^((p+1)/m)       p+1 &gt;= m
</pre><p>The eBase vector contains (or should contain) implicitly information about the size of the ODE's dependent variables and should never contain zero values. eFrac relates to the relative accuracy wanted for each dependent variable along the solution path of the ODE. Hence eFrac should always be &lt; 1. The step size estimate for a Runge Kutta of order p &gt;= m starts from the equation: </p><pre class="fragment">                eFrac * eBase &gt;= E(p+1)
</pre><p>and uses the above postulate for E(p+1) to get: </p><pre class="fragment">          h &lt;= eFrac^(1/(p+1)) * [m! / max |y^(m)(x)/eBase|]^(1/m)
</pre><p>For calculating our step size estimate for a given Runge Kutta order p, we use the m = 1 and m = 2 error estimate formulas. The following steps are taken: </p><pre class="fragment">          1) Is max |y''(x)| &gt; 0? If yes, use:

                 h = eFrac^(1/(p+1)) * sqrt (2) / sqrt (max |y''(x)/eBase|)
                 h = min (h, hmax)

             for orders p &gt;= 1. If no, go to step 2).

          2) Is max |y'(x)| &gt; 0? If yes, use:

                 h = eFrac^(1/(p+1)) / max |y'(x)/eBase|
                 h = min (h, hmax)

             for orders p &gt;= 1. If no, goto step 3).

          3) Use:

                 h = hmax

             for all orders.
</pre><p>NOTES</p>
<p>Contains an interfaced function in the declarations (see below). </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
